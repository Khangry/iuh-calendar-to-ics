<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>IUH Calendar to ICS - Tool</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h2>IUH Calendar to ICS</h2>
      <form id="convertForm" onsubmit="return handleSubmit(event)">
        <label for="iuhLink">
          Dán link lịch học IUH:
          <span class="required">*</span>
        </label>
        <input
          type="text"
          id="iuhLink"
          placeholder="https://sv.iuh.edu.vn/tra-cuu/lich-hoc-theo-tuan.html?k=..."
          required
        />
        <div class="note">
          Lấy link từ mục <b>Lịch theo tuần</b> trên trang tra cứu IUH.
        </div>
        <label for="weeks">
          Số tuần cần lấy (mặc định là: 8):
          <span class="required">*</span>
        </label>
        <input id="weeks" type="text" value="8" required>
        </input>
        <label for="type">
          Loại dữ liệu:
          <span class="required">*</span>
        </label>
        <select id="type" onchange="updateButtonText()" required>
          <option value="ics">Lấy link .ics</option>
          <option value="json">Lấy dữ liệu JSON</option>
        </select>
        <button type="submit" id="submitBtn">Lấy lịch học</button>
      </form>
      <div id="error"></div>
      <div id="copied">Đã copy link .ics vào clipboard!</div>
    </div>
    <script src="main.js"></script>
  </body>
    </style>
    <script>
      function updateButtonText() {
        const type = document.getElementById('type').value;
        const btn = document.getElementById('submitBtn');
        if (type === 'ics') {
          btn.textContent = 'Copy link lịch học';
        } else {
          btn.textContent = 'Lấy lịch học';
        }
      }
      function showError(msg) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = msg;
        errorDiv.style.display = 'block';
      }
      function hideError() {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
      }
      function handleSubmit(e) {
        e.preventDefault();
        hideError();
        document.getElementById('copied').style.display = 'none';

        const link = document.getElementById('iuhLink').value.trim();
        const weeks = document.getElementById('weeks').value.trim();
        const type = document.getElementById('type').value;

        if (!link) {
          showError('Vui lòng nhập link lịch học IUH!');
          document.getElementById('iuhLink').focus();
          return false;
        }
        if (!weeks || isNaN(weeks) || parseInt(weeks) <= 0) {
          showError('Vui lòng nhập số tuần hợp lệ (là số nguyên dương)');
          document.getElementById('weeks').focus();
          return false;
        }
        if (!type) {
          showError('Vui lòng chọn loại dữ liệu!');
          document.getElementById('type').focus();
          return false;
        }

        // Tách mã k từ link
        const match = link.match(/[?&]k=([A-Za-z0-9_\-]+)/);
        if (!match) {
          showError('Không tìm thấy mã k trong link. Vui lòng kiểm tra lại!');
          document.getElementById('iuhLink').focus();
          return false;
        }
        const k = match[1];

        let url = '';
        if (type === 'ics') {
          url = `${window.location.origin}/schedule?k=${encodeURIComponent(k)}&w=${weeks}`;
          navigator.clipboard.writeText(url).then(() => {
            document.getElementById('copied').style.display = 'block';
          });
        } else {
          url = `/api?k=${encodeURIComponent(k)}&w=${weeks}`;
          window.location.href = url;
        }
        return false;
      }
      updateButtonText();
    </script>
  </body>
</html>
